<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Temperature Monitor</title>
    <script src="https://cdn.jsdelivr.net/npm/echarts@5.4.3/dist/echarts.min.js"></script>
    <style>
      :root {
        --color-background: #ffffff;
        --color-surface: #f8f9fa;
        --color-text: #212529;
        --color-text-secondary: #6c757d;
        --color-border: #dee2e6;
        --color-primary: #0d6efd;
        --color-chart-bg: #ffffff;
      }

      [data-theme="dark"] {
        --color-background: #1a1a1a;
        --color-surface: #2d2d2d;
        --color-text: #e9ecef;
        --color-text-secondary: #adb5bd;
        --color-border: #495057;
        --color-primary: #0d6efd;
        --color-chart-bg: #2d2d2d;
      }

      * {
        margin: 0;
        padding: 0;
        box-sizing: border-box;
      }

      body {
        font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto,
          "Helvetica Neue", Arial, sans-serif;
        background-color: var(--color-background);
        color: var(--color-text);
        line-height: 1.6;
        transition: background-color 0.3s ease, color 0.3s ease;
      }

      .container {
        max-width: 1200px;
        margin: 0 auto;
        padding: 2rem 1rem;
      }

      header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 2rem;
        padding-bottom: 1rem;
        border-bottom: 1px solid var(--color-border);
      }

      h1 {
        font-size: 1.5rem;
        font-weight: 600;
      }

      .current-readings {
        display: flex;
        gap: 1.5rem;
        font-size: 0.875rem;
        color: var(--color-text-secondary);
      }

      .reading {
        display: flex;
        flex-direction: column;
      }

      .reading-label {
        font-size: 0.75rem;
        text-transform: uppercase;
        letter-spacing: 0.05em;
      }

      .reading-value {
        font-size: 1.25rem;
        font-weight: 600;
        color: var(--color-text);
        margin-top: 0.25rem;
      }

      .theme-toggle {
        background: var(--color-surface);
        border: 1px solid var(--color-border);
        border-radius: 8px;
        padding: 0.5rem 1rem;
        cursor: pointer;
        color: var(--color-text);
        font-size: 0.875rem;
        transition: all 0.2s ease;
      }

      .theme-toggle:hover {
        background: var(--color-border);
      }

      .chart-section {
        background: var(--color-surface);
        border: 1px solid var(--color-border);
        border-radius: 12px;
        padding: 1.5rem;
        min-height: 500px;
      }

      #temperatureChart {
        width: 100%;
        height: 500px;
      }

      .loading {
        text-align: center;
        padding: 3rem;
        color: var(--color-text-secondary);
      }

      .error {
        text-align: center;
        padding: 3rem;
        color: #dc3545;
      }

      @media (max-width: 768px) {
        header {
          flex-direction: column;
          align-items: flex-start;
          gap: 1rem;
        }

        .current-readings {
          width: 100%;
          justify-content: space-between;
        }

        .theme-toggle {
          align-self: flex-end;
        }
      }
    </style>
  </head>
  <body>
    <div class="container">
      <header>
        <div>
          <div class="current-readings">
          <div class="reading">
          <span class="reading-label">CO Temp</span>
          <span class="reading-value" id="currentTempCo">--¬∞C</span>
          </div>
          <div class="reading">
          <span class="reading-label">Room Temp</span>
          <span class="reading-value" id="currentTempRoom">--¬∞C</span>
          </div>
          <div class="reading">
          <span class="reading-label">Humidity</span>
          <span class="reading-value" id="currentHumidity">--%</span>
          </div>
            <div class="reading">
              <span class="reading-label">Last Update</span>
              <span class="reading-value" id="lastUpdate">--</span>
            </div>
          </div>
        </div>
        <button class="theme-toggle" onclick="toggleTheme()">
          <span id="themeIcon">üåô</span>
        </button>
      </header>

      <div class="chart-section">
        <div id="temperatureChart"></div>
      </div>
    </div>

    <script>
      let chart;
      const REFRESH_INTERVAL = 5 * 60 * 1000; // 5 minutes

      function initTheme() {
        const savedTheme = localStorage.getItem("theme") || "light";
        document.documentElement.setAttribute("data-theme", savedTheme);
        updateThemeIcon(savedTheme);
      }

      function toggleTheme() {
        const currentTheme =
          document.documentElement.getAttribute("data-theme");
        const newTheme = currentTheme === "dark" ? "light" : "dark";
        document.documentElement.setAttribute("data-theme", newTheme);
        localStorage.setItem("theme", newTheme);
        updateThemeIcon(newTheme);

        if (chart) {
          updateChartTheme();
        }
      }

      function updateThemeIcon(theme) {
        document.getElementById("themeIcon").textContent =
          theme === "dark" ? "‚òÄÔ∏è" : "üåô";
      }

      function initChart() {
        const chartDom = document.getElementById("temperatureChart");
        chart = echarts.init(chartDom);

        const option = {
          backgroundColor: "transparent",
          title: {
            text: "Temperature Readings",
            left: "center",
            textStyle: {
              color: getComputedStyle(document.documentElement)
                .getPropertyValue("--color-text")
                .trim(),
              fontSize: 16,
              fontWeight: 600,
            },
          },
          tooltip: {
            trigger: "axis",
            axisPointer: {
              type: "cross",
            },
            formatter: function (params) {
              let result = params[0].axisValueLabel + "<br/>";
              params.forEach((param) => {
                let unit = param.seriesName.includes("Humidity") ? "%" : "¬∞C";
                result +=
                  param.marker +
                  param.seriesName +
                  ": " +
                  param.value[1].toFixed(2) +
                  unit +
                  "<br/>";
              });
              return result;
            },
          },
          legend: {
            data: ["CO Temperature", "Room Temperature", "Humidity"],
            top: 30,
            textStyle: {
              color: getComputedStyle(document.documentElement)
                .getPropertyValue("--color-text")
                .trim(),
            },
          },
          grid: {
            left: "3%",
            right: "4%",
            bottom: "3%",
            top: 80,
            containLabel: true,
          },
          xAxis: {
            type: "time",
            boundaryGap: false,
            axisLine: {
              lineStyle: {
                color: getComputedStyle(document.documentElement)
                  .getPropertyValue("--color-border")
                  .trim(),
              },
            },
            axisLabel: {
              color: getComputedStyle(document.documentElement)
                .getPropertyValue("--color-text-secondary")
                .trim(),
              formatter: function (value) {
                const date = new Date(value);
                return date.toLocaleTimeString("en-US", {
                  hour: "2-digit",
                  minute: "2-digit",
                });
              },
            },
          },
          yAxis: {
            type: "value",
            name: "Value",
            nameTextStyle: {
              color: getComputedStyle(document.documentElement)
                .getPropertyValue("--color-text-secondary")
                .trim(),
            },
            axisLine: {
              lineStyle: {
                color: getComputedStyle(document.documentElement)
                  .getPropertyValue("--color-border")
                  .trim(),
              },
            },
            axisLabel: {
              color: getComputedStyle(document.documentElement)
                .getPropertyValue("--color-text-secondary")
                .trim(),
            },
            splitLine: {
              lineStyle: {
                color: getComputedStyle(document.documentElement)
                  .getPropertyValue("--color-border")
                  .trim(),
                opacity: 0.3,
              },
            },
          },
          series: [
            {
              name: "CO Temperature",
              type: "line",
              smooth: true,
              lineStyle: {
                width: 2,
              },
              emphasis: {
                focus: "series",
              },
              data: [],
            },
            {
              name: "Room Temperature",
              type: "line",
              smooth: true,
              lineStyle: {
                width: 2,
              },
              emphasis: {
                focus: "series",
              },
              data: [],
            },
            {
              name: "Humidity",
              type: "line",
              smooth: true,
              lineStyle: {
                width: 2,
              },
              emphasis: {
                focus: "series",
              },
              data: [],
            },
          ],
        };

        chart.setOption(option);

        window.addEventListener("resize", () => {
          chart.resize();
        });
      }

      function updateChartTheme() {
        if (!chart) return;

        chart.setOption({
          title: {
            textStyle: {
              color: getComputedStyle(document.documentElement)
                .getPropertyValue("--color-text")
                .trim(),
            },
          },
          legend: {
            textStyle: {
              color: getComputedStyle(document.documentElement)
                .getPropertyValue("--color-text")
                .trim(),
            },
          },
          xAxis: {
            axisLine: {
              lineStyle: {
                color: getComputedStyle(document.documentElement)
                  .getPropertyValue("--color-border")
                  .trim(),
              },
            },
            axisLabel: {
              color: getComputedStyle(document.documentElement)
                .getPropertyValue("--color-text-secondary")
                .trim(),
            },
          },
          yAxis: {
            nameTextStyle: {
              color: getComputedStyle(document.documentElement)
                .getPropertyValue("--color-text-secondary")
                .trim(),
            },
            axisLine: {
              lineStyle: {
                color: getComputedStyle(document.documentElement)
                  .getPropertyValue("--color-border")
                  .trim(),
              },
            },
            axisLabel: {
              color: getComputedStyle(document.documentElement)
                .getPropertyValue("--color-text-secondary")
                .trim(),
            },
            splitLine: {
              lineStyle: {
                color: getComputedStyle(document.documentElement)
                  .getPropertyValue("--color-border")
                  .trim(),
              },
            },
          },
        });
      }

      async function fetchTemperatureData() {
        try {
          const response = await fetch("/data?limit=100&offset=0");
          if (!response.ok) {
            throw new Error("Failed to fetch data");
          }

          const readings = await response.json();

          if (readings && readings.length > 0) {
            updateCurrentReadings(readings[0]);
            updatePageTitle(readings[0]);

            // Reverse data for chart (oldest to newest)
            const reversedReadings = [...readings].reverse();

            const tempCoData = reversedReadings.map((r) => [
              r.timestamp ? r.timestamp * 1000 : Date.now(),
              r.tempCo,
            ]);

            const tempRoomData = reversedReadings.map((r) => [
              r.timestamp ? r.timestamp * 1000 : Date.now(),
              r.tempRoom,
            ]);

            const humidityData = reversedReadings.map((r) => [
              r.timestamp ? r.timestamp * 1000 : Date.now(),
              r.humidity,
            ]);

            chart.setOption({
              series: [{ data: tempCoData }, { data: tempRoomData }, { data: humidityData }],
            });
          }
        } catch (error) {
          console.error("Error fetching temperature data:", error);
          document.getElementById("currentTempCo").textContent = "Error";
          document.getElementById("currentTempRoom").textContent = "Error";
          document.getElementById("currentHumidity").textContent = "Error";
        }
      }

      function updateCurrentReadings(reading) {
        document.getElementById("currentTempCo").textContent =
          reading.tempCo.toFixed(2) + "¬∞C";
        document.getElementById("currentTempRoom").textContent =
          reading.tempRoom.toFixed(2) + "¬∞C";
        document.getElementById("currentHumidity").textContent =
          reading.humidity.toFixed(2) + "%";

        if (reading.timestamp) {
          const date = new Date(reading.timestamp * 1000);
          document.getElementById("lastUpdate").textContent =
            date.toLocaleTimeString("en-US", {
              hour: "2-digit",
              minute: "2-digit",
              second: "2-digit",
            });
        }
      }

      function updatePageTitle(reading) {
        const coReading = reading.tempCo.toFixed(2) + "¬∞C";
        const roomReading = reading.tempRoom.toFixed(2) + "¬∞C";
        document.title = "CO:" + coReading + " | Room: " + roomReading;
      }

      document.addEventListener("DOMContentLoaded", () => {
        initTheme();
        initChart();
        fetchTemperatureData();

        // Refresh data every 5 minutes
        setInterval(fetchTemperatureData, REFRESH_INTERVAL);
      });
    </script>
  </body>
</html>
