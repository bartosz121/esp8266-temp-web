<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Temperature Monitor</title>
    <script src="https://cdn.jsdelivr.net/npm/echarts@5.4.3/dist/echarts.min.js"></script>
    <style>
      :root {
        --color-background: #ffffff;
        --color-surface: #f8f9fa;
        --color-text: #212529;
        --color-text-secondary: #6c757d;
        --color-border: #dee2e6;
        --color-primary: #0d6efd;
        --color-chart-bg: #ffffff;
      }

      [data-theme="dark"] {
        --color-background: #1a1a1a;
        --color-surface: #2d2d2d;
        --color-text: #e9ecef;
        --color-text-secondary: #adb5bd;
        --color-border: #495057;
        --color-primary: #0d6efd;
        --color-chart-bg: #2d2d2d;
      }

      * {
        margin: 0;
        padding: 0;
        box-sizing: border-box;
      }

      body {
        font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI",
          Roboto, Oxygen, Ubuntu, Cantarell, "Open Sans", "Helvetica Neue",
          sans-serif, "Helvetica Neue", Arial, sans-serif;
        background-color: var(--color-background);
        color: var(--color-text);
        line-height: 1.6;
        transition: background-color 0.3s ease, color 0.3s ease;
      }

      .container {
        max-width: 1200px;
        margin: 0 auto;
        padding: 2rem 1rem;
      }

      header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 2rem;
        padding-bottom: 1rem;
        border-bottom: 1px solid var(--color-border);
      }

      h1 {
        font-size: 1.5rem;
        font-weight: 600;
      }

      .current-readings {
        display: flex;
        gap: 1.5rem;
        font-size: 0.875rem;
        color: var(--color-text-secondary);
      }

      .reading {
        display: flex;
        flex-direction: column;
      }

      .reading-label {
        font-size: 0.75rem;
        text-transform: uppercase;
        letter-spacing: 0.05em;
      }

      .reading-value {
        font-size: 1.25rem;
        font-weight: 600;
        color: var(--color-text);
        margin-top: 0.25rem;
      }

      .theme-toggle {
        background: var(--color-surface);
        border: 1px solid var(--color-border);
        border-radius: 8px;
        padding: 0.5rem 1rem;
        cursor: pointer;
        color: var(--color-text);
        font-size: 0.875rem;
        transition: all 0.2s ease;
      }

      .theme-toggle:hover {
        background: var(--color-border);
      }

      .chart-section {
        background: var(--color-surface);
        border: 1px solid var(--color-border);
        border-radius: 12px;
        padding: 1.5rem;
        min-height: 500px;
      }

      .zoom-info {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 1rem;
        font-size: 0.875rem;
        color: var(--color-text-secondary);
      }

      .zoom-range {
        background: var(--color-background);
        padding: 0.5rem 1rem;
        border-radius: 6px;
        border: 1px solid var(--color-border);
        font-family: monospace;
        height: 2rem;
        line-height: 1;
      }

      .load-more-btn {
        background: var(--color-background);
        border: 1px solid var(--color-border);
        border-radius: 6px;
        padding: 0.5rem 1rem;
        cursor: pointer;
        color: var(--color-text);
        font-size: 0.875rem;
        transition: all 0.2s ease;
        font-family: inherit;
        height: 2rem;
        line-height: 1;
      }

      .load-more-btn:hover:not(:disabled) {
        background: var(--color-border);
      }

      .load-more-btn:disabled {
        background: var(--color-surface);
        color: var(--color-text-secondary);
        cursor: not-allowed;
        opacity: 0.6;
      }

      #temperatureChart {
        width: 100%;
        height: 500px;
      }

      .loading {
        text-align: center;
        padding: 3rem;
        color: var(--color-text-secondary);
      }

      .error {
        text-align: center;
        padding: 3rem;
        color: #dc3545;
      }

      @media (max-width: 768px) {
        header {
          flex-direction: row;
          align-items: flex-start;
          gap: 1rem;
        }

        .current-readings {
          flex-direction: column;
          gap: 1rem;
        }

        .theme-toggle {
          margin-left: auto;
        }

        .zoom-info {
          flex-direction: column;
          align-items: flex-start;
          gap: 0.5rem;
        }

        .zoom-range {
          width: 100%;
          text-align: center;
          height: auto;
          line-height: normal;
        }

        .load-more-btn {
          width: 100%;
          text-align: center;
        }
      }
    </style>
  </head>
  <body>
    <div class="container">
      <header>
        <div>
          <div class="current-readings">
            <div class="reading">
              <span class="reading-label">CO Temp</span>
              <span class="reading-value" id="currentTempCo">--¬∞C</span>
            </div>
            <div class="reading">
              <span class="reading-label">Room Temp</span>
              <span class="reading-value" id="currentTempRoom">--¬∞C</span>
            </div>
            <div class="reading">
              <span class="reading-label">Humidity</span>
              <span class="reading-value" id="currentHumidity">--%</span>
            </div>
            <div class="reading">
              <span class="reading-label">Last Update</span>
              <span class="reading-value" id="lastUpdate">--</span>
            </div>
          </div>
        </div>
        <button class="theme-toggle" onclick="toggleTheme()">
          <span id="themeIcon">üåô</span>
        </button>
      </header>

      <div class="chart-section">
        <div id="temperatureChart"></div>
        <div class="zoom-info">
          <div class="zoom-range" id="zoomRange">Loading...</div>
          <button
            class="load-more-btn"
            id="loadMoreBtn"
            onclick="loadMoreData()"
          >
            Load More Data
          </button>
        </div>
      </div>
    </div>

    <script>
      let chart;
      const REFRESH_INTERVAL = 5 * 60 * 1000; // 5 minutes
      let allReadings = [];
      let currentOffset = 0;
      let isFetchingMore = false;
      let loadMoreOffset = 100; // Separate offset for loading more data

      function initTheme() {
        const savedTheme = localStorage.getItem("theme") || "light";
        document.documentElement.setAttribute("data-theme", savedTheme);
        updateThemeIcon(savedTheme);
      }

      function toggleTheme() {
        const currentTheme =
          document.documentElement.getAttribute("data-theme");
        const newTheme = currentTheme === "dark" ? "light" : "dark";
        document.documentElement.setAttribute("data-theme", newTheme);
        localStorage.setItem("theme", newTheme);
        updateThemeIcon(newTheme);

        if (chart) {
          updateChartTheme();
        }
      }

      function updateThemeIcon(theme) {
        document.getElementById("themeIcon").textContent =
          theme === "dark" ? "‚òÄÔ∏è" : "üåô";
      }

      function initChart() {
        const chartDom = document.getElementById("temperatureChart");
        chart = echarts.init(chartDom);

        const option = {
          backgroundColor: "transparent",
          title: {
            text: "Temperature Readings",
            left: "center",
            textStyle: {
              color: getComputedStyle(document.documentElement)
                .getPropertyValue("--color-text")
                .trim(),
              fontSize: 16,
              fontWeight: 600,
            },
          },
          tooltip: {
            trigger: "axis",
            axisPointer: {
              type: "cross",
            },
            formatter: function (params) {
              let result = params[0].axisValueLabel + "<br/>";
              params.forEach((param) => {
                let unit = param.seriesName.includes("Humidity") ? "%" : "¬∞C";
                result +=
                  param.marker +
                  param.seriesName +
                  ": " +
                  param.value[1].toFixed(2) +
                  unit +
                  "<br/>";
              });
              return result;
            },
          },
          legend: {
            data: ["CO Temperature", "Room Temperature", "Humidity"],
            top: 30,
            textStyle: {
              color: getComputedStyle(document.documentElement)
                .getPropertyValue("--color-text")
                .trim(),
            },
          },
          grid: {
            left: "3%",
            right: "4%",
            bottom: "15%",
            top: 80,
            containLabel: true,
          },
          dataZoom: [
            {
              type: "slider",
              start: 50,
              end: 100,
              bottom: "5%",
            },
            {
              type: "inside",
              start: 50,
              end: 100,
            },
          ],
          xAxis: {
            type: "time",
            boundaryGap: false,
            axisLine: {
              lineStyle: {
                color: getComputedStyle(document.documentElement)
                  .getPropertyValue("--color-border")
                  .trim(),
              },
            },
            axisLabel: {
              color: getComputedStyle(document.documentElement)
                .getPropertyValue("--color-text-secondary")
                .trim(),
              formatter: function (value) {
                const date = new Date(value);
                return date.toLocaleTimeString("en-US", {
                  hour: "2-digit",
                  minute: "2-digit",
                });
              },
            },
          },
          yAxis: {
            type: "value",
            name: "Value",
            nameTextStyle: {
              color: getComputedStyle(document.documentElement)
                .getPropertyValue("--color-text-secondary")
                .trim(),
            },
            axisLine: {
              lineStyle: {
                color: getComputedStyle(document.documentElement)
                  .getPropertyValue("--color-border")
                  .trim(),
              },
            },
            axisLabel: {
              color: getComputedStyle(document.documentElement)
                .getPropertyValue("--color-text-secondary")
                .trim(),
            },
            splitLine: {
              lineStyle: {
                color: getComputedStyle(document.documentElement)
                  .getPropertyValue("--color-border")
                  .trim(),
                opacity: 0.3,
              },
            },
          },
          series: [
            {
              name: "CO Temperature",
              type: "line",
              smooth: true,
              lineStyle: {
                width: 2,
              },
              emphasis: {
                focus: "series",
              },
              data: [],
            },
            {
              name: "Room Temperature",
              type: "line",
              smooth: true,
              lineStyle: {
                width: 2,
              },
              emphasis: {
                focus: "series",
              },
              data: [],
            },
            {
              name: "Humidity",
              type: "line",
              smooth: true,
              lineStyle: {
                width: 2,
              },
              emphasis: {
                focus: "series",
              },
              data: [],
            },
          ],
        };

        chart.setOption(option);

        window.addEventListener("resize", () => {
          chart.resize();
        });

        // Listen for dataZoom events to update timestamp display
        chart.on("dataZoom", updateZoomDisplay);
      }

      function updateChartTheme() {
        if (!chart) return;

        chart.setOption({
          title: {
            textStyle: {
              color: getComputedStyle(document.documentElement)
                .getPropertyValue("--color-text")
                .trim(),
            },
          },
          legend: {
            textStyle: {
              color: getComputedStyle(document.documentElement)
                .getPropertyValue("--color-text")
                .trim(),
            },
          },
          xAxis: {
            axisLine: {
              lineStyle: {
                color: getComputedStyle(document.documentElement)
                  .getPropertyValue("--color-border")
                  .trim(),
              },
            },
            axisLabel: {
              color: getComputedStyle(document.documentElement)
                .getPropertyValue("--color-text-secondary")
                .trim(),
            },
          },
          yAxis: {
            nameTextStyle: {
              color: getComputedStyle(document.documentElement)
                .getPropertyValue("--color-text-secondary")
                .trim(),
            },
            axisLine: {
              lineStyle: {
                color: getComputedStyle(document.documentElement)
                  .getPropertyValue("--color-border")
                  .trim(),
              },
            },
            axisLabel: {
              color: getComputedStyle(document.documentElement)
                .getPropertyValue("--color-text-secondary")
                .trim(),
            },
            splitLine: {
              lineStyle: {
                color: getComputedStyle(document.documentElement)
                  .getPropertyValue("--color-border")
                  .trim(),
              },
            },
          },
        });
      }

      function updateZoomDisplay() {
        if (!chart) return;

        const dataZoom = chart.getOption().dataZoom[0];
        if (dataZoom && dataZoom.startValue && dataZoom.endValue) {
          const startDate = new Date(dataZoom.startValue);
          const endDate = new Date(dataZoom.endValue);

          const formatDateTime = (date) => {
            const year = date.getFullYear();
            const month = String(date.getMonth() + 1).padStart(2, "0");
            const day = String(date.getDate()).padStart(2, "0");
            const hours = String(date.getHours()).padStart(2, "0");
            const minutes = String(date.getMinutes()).padStart(2, "0");
            return `${year}/${month}/${day} ${hours}:${minutes}`;
          };

          const startStr = formatDateTime(startDate);
          const endStr = formatDateTime(endDate);

          document.getElementById(
            "zoomRange"
          ).textContent = `${startStr} - ${endStr}`;
        }
      }

      async function fetchTemperatureData(offset = 0, append = false) {
        try {
          const response = await fetch(`/data?limit=100&offset=${offset}`);
          if (!response.ok) {
            throw new Error("Failed to fetch data");
          }

          const readings = await response.json();

          if (readings && Array.isArray(readings) && readings.length > 0) {
            if (!append) {
              // For refresh/initial load, update current readings
              updateCurrentReadings(readings[0]);
              updatePageTitle(readings[0]);
            }

            // Reverse data for chart (oldest to newest)
            const reversedReadings = [...readings].reverse();

            const tempCoData = reversedReadings.map((r) => [
              r.timestamp ? r.timestamp * 1000 : Date.now(),
              r.tempCo,
            ]);

            const tempRoomData = reversedReadings.map((r) => [
              r.timestamp ? r.timestamp * 1000 : Date.now(),
              r.tempRoom,
            ]);

            const humidityData = reversedReadings.map((r) => [
              r.timestamp ? r.timestamp * 1000 : Date.now(),
              r.humidity,
            ]);

            if (append && chart) {
              // Append data to existing chart data
              const currentOption = chart.getOption();
              const currentCoData = currentOption.series[0].data || [];
              const currentRoomData = currentOption.series[1].data || [];
              const currentHumidityData = currentOption.series[2].data || [];

              chart.setOption({
                series: [
                  { data: [...currentCoData, ...tempCoData] },
                  { data: [...currentRoomData, ...tempRoomData] },
                  { data: [...currentHumidityData, ...humidityData] },
                ],
              });
            } else {
              // Replace data for initial load/refresh
              chart.setOption({
                series: [
                  { data: tempCoData },
                  { data: tempRoomData },
                  { data: humidityData },
                ],
              });

              // Update zoom display after initial data load
              updateZoomDisplay();
            }
          } else if (append) {
            // No more data to load (empty array, null, undefined, or invalid response)
            const btn = document.getElementById("loadMoreBtn");
            btn.textContent = "No More Data";
            btn.disabled = true;
          }
        } catch (error) {
          console.error("Error fetching temperature data:", error);
          if (!append) {
            document.getElementById("currentTempCo").textContent = "Error";
            document.getElementById("currentTempRoom").textContent = "Error";
            document.getElementById("currentHumidity").textContent = "Error";
          }
        }
      }

      async function loadMoreData() {
        const btn = document.getElementById("loadMoreBtn");
        if (btn.disabled) return;

        btn.textContent = "Loading...";
        btn.disabled = true;

        try {
          await fetchTemperatureData(loadMoreOffset, true);
          loadMoreOffset += 100;
          // Only re-enable if not disabled due to no more data
          if (btn.textContent !== "No More Data") {
            btn.textContent = "Load More Data";
            btn.disabled = false;
          }
        } catch (error) {
          // Re-enable on error
          btn.textContent = "Load More Data";
          btn.disabled = false;
          throw error; // Re-throw to maintain error handling
        }
      }

      function updateCurrentReadings(reading) {
        document.getElementById("currentTempCo").textContent =
          reading.tempCo.toFixed(2) + "¬∞C";
        document.getElementById("currentTempRoom").textContent =
          reading.tempRoom.toFixed(2) + "¬∞C";
        document.getElementById("currentHumidity").textContent =
          reading.humidity.toFixed(2) + "%";

        if (reading.timestamp) {
          const date = new Date(reading.timestamp * 1000);
          const year = date.getFullYear();
          const month = String(date.getMonth() + 1).padStart(2, "0");
          const day = String(date.getDate()).padStart(2, "0");
          const dateStr = `${year}/${month}/${day}`;
          const timeStr = date.toLocaleTimeString("en-US", {
            hour: "2-digit",
            minute: "2-digit",
            second: "2-digit",
          });
          document.getElementById(
            "lastUpdate"
          ).textContent = `${timeStr} | ${dateStr}`;
        }
      }

      function updatePageTitle(reading) {
        const coReading = reading.tempCo.toFixed(2) + "¬∞C";
        const roomReading = reading.tempRoom.toFixed(2) + "¬∞C";
        document.title = "CO:" + coReading + " | Room: " + roomReading;
      }

      document.addEventListener("DOMContentLoaded", () => {
        initTheme();
        initChart();
        fetchTemperatureData();

        // Refresh data every 5 minutes
        setInterval(fetchTemperatureData, REFRESH_INTERVAL);
      });
    </script>
  </body>
</html>
